<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»ªè¡¨æ¿ - ä¸­å¤®å¨æˆ¿ç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">ğŸ­ ä¸­å¤®å¨æˆ¿ç®¡ç†ç³»ç»Ÿ</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/dashboard">ä»ªè¡¨æ¿</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/franchises">åŠ ç›Ÿå•†ç®¡ç†</a>
                    </li>
                    <li class="nav-item" sec:authorize="hasRole('ADMIN')">
                        <a class="nav-link" href="/admin/users">ç”¨æˆ·ç®¡ç†</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <span sec:authentication="principal.username"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/profile">ä¸ªäººèµ„æ–™</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><form th:action="@{/logout}" method="post" style="display: inline;">
                                <button type="submit" class="dropdown-item">ç™»å‡º</button>
                            </form></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- æ¬¢è¿ä¿¡æ¯ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <h5 class="alert-heading">æ¬¢è¿å›æ¥ï¼Œ<span sec:authentication="principal.username"></span>ï¼</h5>
                    <p class="mb-0">ä»Šå¤©æ˜¯ <span th:text="${#dates.format(#dates.createNow(), 'yyyyå¹´MMæœˆddæ—¥ EEEE')}"></span>ï¼Œç¥æ‚¨å·¥ä½œé¡ºåˆ©ï¼</p>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="dashboard-grid">
            <div class="stats-card">
                <h3 th:text="${totalUsers}">0</h3>
                <p>æ€»ç”¨æˆ·æ•°</p>
            </div>
            <div class="stats-card">
                <h3 th:text="${totalFranchises}">0</h3>
                <p>æ€»åŠ ç›Ÿå•†æ•°</p>
            </div>
            <div class="stats-card">
                <h3 th:text="${activeFranchises}">0</h3>
                <p>æ´»è·ƒåŠ ç›Ÿå•†</p>
            </div>
            <div class="stats-card">
                <h3 th:text="${adminUsers + franchiseUsers + managerUsers + kitchenUsers}">0</h3>
                <p>æ´»è·ƒç”¨æˆ·</p>
            </div>
        </div>

        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="row">
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="mb-3">ç”¨æˆ·è§’è‰²åˆ†å¸ƒ</h5>
                    <canvas id="userRoleChart"></canvas>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="mb-3">åŠ ç›Ÿå•†çŠ¶æ€åˆ†å¸ƒ</h5>
                    <canvas id="franchiseStatusChart"></canvas>
                </div>
            </div>
        </div>

        <!-- å¿«é€Ÿæ“ä½œ -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">å¿«é€Ÿæ“ä½œ</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <a href="/franchises/new" class="btn btn-success w-100 mb-2">
                                    â• æ·»åŠ åŠ ç›Ÿå•†
                                </a>
                            </div>
                            <div class="col-md-3">
                                <a href="/franchises/active" class="btn btn-primary w-100 mb-2">
                                    ğŸ“Š æŸ¥çœ‹æ´»è·ƒåŠ ç›Ÿå•†
                                </a>
                            </div>
                            <div class="col-md-3" sec:authorize="hasRole('ADMIN')">
                                <a href="/admin/users/new" class="btn btn-warning w-100 mb-2">
                                    ğŸ‘¤ æ·»åŠ ç”¨æˆ·
                                </a>
                            </div>
                            <div class="col-md-3">
                                <a href="/api/health" class="btn btn-info w-100 mb-2" target="_blank">
                                    ğŸ” ç³»ç»Ÿå¥åº·æ£€æŸ¥
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœ€è¿‘æ´»åŠ¨ -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">ç³»ç»Ÿä¿¡æ¯</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>æ•°æ®åº“çŠ¶æ€</h6>
                                <p class="text-success">âœ… H2æ•°æ®åº“è¿è¡Œæ­£å¸¸</p>
                                <p class="text-muted small">è¿æ¥åœ°å€: jdbc:h2:mem:testdb</p>
                            </div>
                            <div class="col-md-6">
                                <h6>ç³»ç»ŸæœåŠ¡</h6>
                                <p class="text-success">âœ… Spring Bootåº”ç”¨è¿è¡Œæ­£å¸¸</p>
                                <p class="text-muted small">ç«¯å£: 8081</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ç”¨æˆ·è§’è‰²åˆ†å¸ƒå›¾è¡¨
        const userRoleCtx = document.getElementById('userRoleChart').getContext('2d');
        const userRoleData = {
            labels: ['ç®¡ç†å‘˜', 'åŠ ç›Ÿå•†', 'åº—é•¿', 'å¨æˆ¿ç®¡ç†å‘˜'],
            datasets: [{
                data: [/*[[${adminUsers}]]*/, /*[[${franchiseUsers}]]*/, /*[[${managerUsers}]]*/, /*[[${kitchenUsers}]]*/],
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0'
                ],
                hoverBackgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0'
                ]
            }]
        };

        new Chart(userRoleCtx, {
            type: 'doughnut',
            data: userRoleData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });

        // åŠ ç›Ÿå•†çŠ¶æ€åˆ†å¸ƒå›¾è¡¨
        const franchiseStatusCtx = document.getElementById('franchiseStatusChart').getContext('2d');
        const franchiseStatusData = {
            labels: ['æ´»è·ƒ', 'æš‚åœ', 'åœç”¨'],
            datasets: [{
                data: [/*[[${activeFranchises}]]*/, /*[[${totalFranchises - activeFranchises}]]*/, 0],
                backgroundColor: [
                    '#28a745',
                    '#ffc107',
                    '#dc3545'
                ],
                hoverBackgroundColor: [
                    '#28a745',
                    '#ffc107',
                    '#dc3545'
                ]
            }]
        };

        new Chart(franchiseStatusCtx, {
            type: 'bar',
            data: franchiseStatusData,
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    </script>
</body>
</html>
